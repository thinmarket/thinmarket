<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ThinMarket</title>
    <link rel="icon" type="image/png" href="assets/img/buttons/favicon.png">
    <style>
        body {
            background-color: #2E2E2E;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .header {
            background-color: #1E1E1E;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .title-container {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            width: 100%;
        }
        .time-container {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        .time-display {
            font-size: 13px;
            color: #ccc;
            font-weight: normal;
            white-space: nowrap;
        }
        .utc-time {
            color: #4CAF50;
            font-weight: bold;
        }
        .image-button {
            height: 80px;
            margin: 10px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .image-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .button-container {
            display: flex;
            flex-wrap: wrap;
            padding: 15px;
            justify-content: flex-start;
            flex-grow: 1;
        }
        .content-wrapper {
            display: flex;
            flex-grow: 1;
            width: 100%;
        }
        .main-content {
            flex-grow: 1;
            width: 75%;
            padding: 10px;
        }
        .sidebar {
            width: 25%;
            min-width: 280px;
            background-color: #252525;
            padding: 10px;
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        h1 {
            font-size: 28px;
            margin: 0;
            color: #fff;
            font-weight: bold;
            min-width: 150px;
        }
        .ticker-container {
            background-color: #1a1a1a;
            color: white;
            padding: 12px 0;
            overflow: hidden;
            position: relative;
            border-top: 1px solid #333;
            flex-shrink: 0;
        }
        .ticker {
            display: inline-block;
            white-space: nowrap;
            padding-left: 100%;
            animation: ticker 300s linear infinite;
        }
        .ticker-item {
            display: inline-block;
            margin-right: 40px;
            font-size: 14px;
        }
        .ticker-name {
            font-weight: bold;
            color: #fff;
        }
        .up { color: #4CAF50; }
        .down { color: #F44336; }
        @keyframes ticker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
        .panel-block {
            background-color: #252525;
            border-radius: 6px;
            padding: 10px;
            font-size: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .panel-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }
        .panel-block-title {
            font-weight: bold;
            color: #fff;
            font-size: 13px;
        }
        .panel-block-toggle {
            background: none;
            border: none;
            color: #aaa;
            font-size: 11px;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .panel-block-toggle:hover {
            background-color: #333;
            color: #fff;
        }
        .panel-block-content {
            display: block;
        }
        .collapsed .panel-block-content {
            display: none;
        }
        .collapsed .panel-block-toggle i {
            transform: rotate(-90deg);
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            align-items: center;
            position: relative;
            border-bottom: 1px solid #333;
        }
        .list-name {
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70px;
        }
        .list-value {
            text-align: right;
            min-width: 60px;
        }
        .list-change {
            text-align: right;
            font-weight: bold;
            min-width: 60px;
        }
        .volume-info {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            font-size: 0.75em;
            color: #aaa;
            display: flex;
            justify-content: space-between;
            padding: 0 5px;
        }
        .stocks-columns {
            display: flex;
            gap: 10px;
        }
        .stocks-column {
            flex: 1;
        }
        .column-title {
            font-size: 10px;
            margin-bottom: 4px;
            padding-bottom: 2px;
            border-bottom: 1px solid;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .column-title.up {
            color: #4CAF50;
            border-color: #4CAF50;
        }
        .column-title.down {
            color: #F44336;
            border-color: #F44336;
        }
        .update-time {
            font-size: 9px;
            color: #888;
            text-align: right;
            margin-top: 5px;
            white-space: nowrap;
        }
        .converter-input {
            width: 100%;
            padding: 6px;
            margin: 5px 0;
            background-color: #333;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
        }
        .converter-select {
            width: 100%;
            padding: 6px;
            margin: 5px 0;
            background-color: #333;
            border: 1px solid #444;
            color: white;
            border-radius: 4px;
        }
        .converter-button {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .converter-result {
            margin-top: 10px;
            padding: 8px;
            background-color: #333;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .header {
                padding: 10px 15px;
            }
            .title-container {
                gap: 10px;
            }
            .time-container {
                gap: 5px;
                margin-top: 3px;
            }
            .time-display {
                font-size: 10px;
            }
            .button-container {
                justify-content: space-around;
                padding: 10px 5px;
            }
            .image-button {
                height: 60px;
                margin: 5px;
                flex: 0 0 calc(50% - 10px);
                max-width: calc(50% - 10px);
            }
            .sidebar {
                padding: 8px;
            }
            .panel-block {
                margin-bottom: 8px;
            }
            .ticker-container {
                padding: 8px 0;
            }
            .ticker-item {
                margin-right: 20px;
                font-size: 12px;
            }
            .list-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 8px 0;
            }
            .volume-info {
                position: static;
                margin-top: 3px;
                padding: 0;
            }
            .list-name, .list-value, .list-change {
                max-width: none;
                min-width: auto;
                text-align: left;
                width: 100%;
                display: flex;
                justify-content: space-between;
            }
        }

        @media (max-width: 480px) {
            .time-display {
                font-size: 9px;
            }
            .image-button {
                height: 50px;
                flex: 0 0 calc(100% - 10px);
                max-width: calc(100% - 10px);
            }
            .list-item {
                font-size: 11px;
            }
            .panel-block-title {
                font-size: 12px;
            }
            .converter-input, .converter-select {
                padding: 5px;
            }
            .converter-button {
                padding: 6px;
            }
            .content-wrapper {
                flex-direction: column;
            }
            .main-content, .sidebar {
                width: 100%;
                min-width: auto;
            }
            .sidebar {
                border-left: none;
                border-top: 1px solid #333;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="title-container">
            <h1>ThinMarket</h1>
            <div class="time-container">
                <span class="time-display utc-time" id="utc-time"></span>
                <span class="time-display" id="moscow-time"></span>
                <span class="time-display" id="london-time"></span>
                <span class="time-display" id="newyork-time"></span>
                <span class="time-display" id="hongkong-time"></span>
                <span class="time-display" id="shanghai-time"></span>
            </div>
        </div>
    </div>
    
    <div class="ticker-container">
        <div class="ticker" id="ticker">Загрузка данных...</div>
    </div>
    
    <div class="content-wrapper">
        <div class="main-content">
            <div class="button-container">
                <a href="moexstock.html">
                    <img src="assets/img/buttons/moexstock.png" alt="Анализ шагов цены" class="image-button">
                </a>
                <a href="Thicalculator_Web.html">
                    <img src="assets/img/buttons/colorThincalculator-web.png" alt="Калькулятор" class="image-button">
                </a>
                <a href="stocks.html">
                    <img src="assets/img/buttons/stocks.png" alt="Акции MOEX" class="image-button">
                </a>
                <a href="marketmap.html">
                    <img src="assets/img/buttons/map.png" alt="Карта рынка" class="image-button">
                </a>
                <a href="moex-monitoring.html">
                    <img src="assets/img/buttons/monitoring.png" alt="Мониторинг акций и фьючерсов" class="image-button">
                </a>
                <a href="moex-weekly-gainers.html">
                    <img src="assets/img/buttons/moex-weekly-gainers.png" alt="Weekly Gainers MOEX" class="image-button">
                </a>
                <a href="bybit-weekly-gainers.html">
                    <img src="assets/img/buttons/bybit-weekly-gainers.png" alt="Bybit Weekly Gainers" class="image-button">
                </a>
                <a href="moex_atr_monitor.html">
                    <img src="assets/img/buttons/moex_atr_monitor.png" alt="ATR-монитор" class="image-button">
                </a>
                <button id="bybit-news-btn" style="background: none; border: none; padding: 0; margin-left: 6px; cursor: pointer; vertical-align: middle;">
                    <img src="assets/img/buttons/bybit-listings.png" alt="Новости Bybit" class="image-button">
                </button>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="panel-block" id="currency-converter-block">
                <div class="panel-block-header">
                    <span class="panel-block-title">Конвертер валют</span>
                    <button class="panel-block-toggle" onclick="togglePanel('currency-converter-block')">
                        <i>▼</i>
                    </button>
                </div>
                <div class="panel-block-content">
                    <input type="number" id="converter-amount" class="converter-input" placeholder="Сумма" value="0">
                    <select id="converter-from" class="converter-select">
                        <option value="RUB">Рубли (RUB)</option>
                        <option value="USD">Доллары (USD)</option>
                        <option value="EUR">Евро (EUR)</option>
                        <option value="CNY">Юань (CNY)</option>
                        <option value="BTC">Bitcoin (BTC)</option>
                        <option value="ETH">Ethereum (ETH)</option>
                        <option value="BNB">Binance Coin (BNB)</option>
                        <option value="SOL">Solana (SOL)</option>
                        <option value="XRP">Ripple (XRP)</option>
                    </select>
                    <select id="converter-to" class="converter-select">
                        <option value="USD">Доллары (USD)</option>
                        <option value="RUB">Рубли (RUB)</option>
                        <option value="EUR">Евро (EUR)</option>
                        <option value="CNY">Юань (CNY)</option>
                        <option value="BTC">Bitcoin (BTC)</option>
                        <option value="ETH">Ethereum (ETH)</option>
                        <option value="BNB">Binance Coin (BNB)</option>
                        <option value="SOL">Solana (SOL)</option>
                        <option value="XRP">Ripple (XRP)</option>
                    </select>
                    <div id="converter-result" class="converter-result">Результат появится здесь</div>
                </div>
            </div>
            
            <div class="panel-block" id="crypto-block">
                <div class="panel-block-header">
                    <span class="panel-block-title">Криптовалюты</span>
                    <button class="panel-block-toggle" onclick="togglePanel('crypto-block')" title="Обновляется каждые 5 минут">
                        <i>▼</i>
                    </button>
                </div>
                <div class="panel-block-content">
                    <div id="crypto-rates"></div>
                    <div class="update-time">Обновление каждые 5 мин</div>
                </div>
            </div>
            
            <!-- Индикатор процента растущих акций (градусник) -->
            <div class="panel-block" id="greed-meter-block">
                <div class="panel-block-header">
                    <span class="panel-block-title">Индикатор рынка MOEX</span>
                    <button class="panel-block-toggle" onclick="togglePanel('greed-meter-block')" title="Обновляется каждые 30 секунд">
                        <i>▼</i>
                    </button>
                </div>
                <div class="panel-block-content">
                    <div id="greed-meter-container">
                        <svg id="greed-meter" width="280" height="100" viewBox="0 0 320 180" style="cursor:pointer; max-width: 100%;">
                            <defs>
                                <linearGradient id="greedGradient" x1="0" y1="1" x2="1" y2="1">
                                    <stop offset="0%" stop-color="#F44336"/>
                                    <stop offset="50%" stop-color="#FFEB3B"/>
                                    <stop offset="100%" stop-color="#4CAF50"/>
                                </linearGradient>
                            </defs>
                            <!-- Дуга сверху: от левого низа через верх к правому низу -->
                            <path d="M40,160 A120,120 0 0,1 280,160" stroke="url(#greedGradient)" stroke-width="18" fill="none"/>
                            <g id="greed-arrow">
                                <line x1="160" y1="160" x2="160" y2="42" stroke="#fff" stroke-width="7" stroke-linecap="round"/>
                                <circle cx="160" cy="160" r="13" fill="#222" stroke="#fff" stroke-width="4"/>
                                <text x="160" y="166" text-anchor="middle" font-size="15" fill="#fff" font-family="Arial">%</text>
                            </g>
                        </svg>
                        <div class="greed-label-text">
                            <span>Сейчас:&nbsp;</span><span id="greed-label" style="color: #4CAF50;">Жадность</span>
                        </div>
                    </div>
                    <div class="update-time">Обновление каждые 30 сек</div>
                </div>
            </div>
            
            <div class="panel-block" id="top-stocks-block">
                <div class="panel-block-header">
                    <span class="panel-block-title">Топ акции</span>
                    <button class="panel-block-toggle" onclick="togglePanel('top-stocks-block')" title="Обновляется каждые 30 секунд">
                        <i>▼</i>
                    </button>
                </div>
                <div class="panel-block-content">
                    <div class="stocks-columns">
                        <div class="stocks-column">
                            <div class="column-title up">Лидеры роста</div>
                            <div id="top-gainers"></div>
                        </div>
                        <div class="stocks-column">
                            <div class="column-title down">Лидеры снижения</div>
                            <div id="top-losers"></div>
                        </div>
                    </div>
                    <div class="update-time">Обновление каждые 30 сек</div>
                </div>
            </div>
            
            <div class="panel-block" id="currency-rates-block">
                <div class="panel-block-header">
                    <span class="panel-block-title">Курсы валют ЦБ РФ</span>
                    <button class="panel-block-toggle" onclick="togglePanel('currency-rates-block')" title="Обновляется ежедневно">
                        <i>▼</i>
                    </button>
                </div>
                <div class="panel-block-content">
                    <div id="currency-rates"></div>
                    <div class="update-time" id="currency-update-time"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно с метриками -->
    <div id="greed-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center;">
        <div style="background: #232323; color: #fff; border-radius: 18px; padding: 32px 28px 24px 28px; min-width: 320px; max-width: 90vw; box-shadow: 0 8px 32px rgba(0,0,0,0.7); position:relative;">
            <button id="close-greed-modal" style="position:absolute; top:12px; right:16px; background:none; border:none; color:#fff; font-size:28px; cursor:pointer;">&times;</button>
            <h2 style="margin-top:0; margin-bottom:18px; font-size: 22px; text-align:center;">Шкала статусов</h2>
            <ul style="list-style:none; padding:0; margin:0; font-size:18px;">
                <li><span style="color:#d32f2f; font-weight:bold;">Экстремальный страх</span> <span style="color:#888;">(0–14%)</span></li>
                <li><span style="color:#F44336; font-weight:bold;">Страх</span> <span style="color:#888;">(15–29%)</span></li>
                <li><span style="color:#FFEB3B; font-weight:bold;">Нейтрально</span> <span style="color:#888;">(30–59%)</span></li>
                <li><span style="color:#4CAF50; font-weight:bold;">Жадность</span> <span style="color:#888;">(60–84%)</span></li>
                <li><span style="color:#388e3c; font-weight:bold;">Экстремальная жадность</span> <span style="color:#888;">(85–100%)</span></li>
            </ul>
        </div>
    </div>
    <style>
    #greed-meter-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 10px 0 10px 0;
    }
    #greed-meter {
        display: block;
        margin: 0 auto;
        max-width: 100vw;
    }
    .greed-label-text {
        margin-top: 8px;
        font-size: 18px;
        font-weight: bold;
        color: #fff;
        text-align: center;
    }
    @media (max-width: 600px) {
        #greed-meter {
            width: 180px;
            height: 90px;
        }
        .greed-label-text {
            font-size: 14px;
        }
    }
    </style>
    <script>
        function updateWorldTime() {
            const options = {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };
            
            const utcOptions = {...options, timeZone: 'UTC'};
            const utcFormatter = new Intl.DateTimeFormat('ru-RU', utcOptions);
            const utcTime = utcFormatter.format(new Date());
            document.getElementById('utc-time').textContent = 'UTC: ' + utcTime;
            
            const moscowOptions = {...options, timeZone: 'Europe/Moscow'};
            const moscowFormatter = new Intl.DateTimeFormat('ru-RU', moscowOptions);
            const moscowTime = moscowFormatter.format(new Date());
            document.getElementById('moscow-time').textContent = 'Москва: ' + moscowTime;
            
            const londonOptions = {...options, timeZone: 'Europe/London'};
            const londonFormatter = new Intl.DateTimeFormat('ru-RU', londonOptions);
            const londonTime = londonFormatter.format(new Date());
            document.getElementById('london-time').textContent = 'Лондон: ' + londonTime;
            
            const nyOptions = {...options, timeZone: 'America/New_York'};
            const nyFormatter = new Intl.DateTimeFormat('ru-RU', nyOptions);
            const nyTime = nyFormatter.format(new Date());
            document.getElementById('newyork-time').textContent = 'Нью-Йорк: ' + nyTime;
            
            const hkOptions = {...options, timeZone: 'Asia/Hong_Kong'};
            const hkFormatter = new Intl.DateTimeFormat('ru-RU', hkOptions);
            const hkTime = hkFormatter.format(new Date());
            document.getElementById('hongkong-time').textContent = 'Гонконг: ' + hkTime;
            
            const shOptions = {...options, timeZone: 'Asia/Shanghai'};
            const shFormatter = new Intl.DateTimeFormat('ru-RU', shOptions);
            const shTime = shFormatter.format(new Date());
            document.getElementById('shanghai-time').textContent = 'Шанхай: ' + shTime;
        }

        const config = {
            updateInterval: 30000,
            board: 'TQBR',
            animationDuration: 300,
            topStocksCount: 5
        };

        let currentRates = { USD: 0, EUR: 0, CNY: 0 };
        let currentCryptoRates = {
            BTC: { price: 0, change: 0 },
            ETH: { price: 0, change: 0 },
            BNB: { price: 0, change: 0 },
            SOL: { price: 0, change: 0 },
            XRP: { price: 0, change: 0 }
        };

        async function loadData() {
            try {
                const url = `https://iss.moex.com/iss/engines/stock/markets/shares/boards/${config.board}/securities.json?iss.meta=off&securities.columns=SECID,SHORTNAME&marketdata.columns=SECID,LAST,LASTTOPREVPRICE,VOLTODAY,VALTODAY`;
                const response = await fetch(url);
                const data = await response.json();
                const securities = data.securities.data;
                const marketData = data.marketdata.data;
                const stocks = securities.map(security => {
                    const ticker = security[0];
                    const name = security[1];
                    const stockData = marketData.find(item => item[0] === ticker);
                    return {
                        ticker,
                        name,
                        price: stockData ? stockData[1] : null,
                        change: stockData ? stockData[2] : null,
                        volume: stockData ? stockData[3] : null,
                        turnover: stockData ? stockData[4] : null
                    };
                }).filter(stock => 
                    stock.price !== null && 
                    stock.change !== null && 
                    stock.turnover !== null &&
                    stock.turnover > 0
                );
                const sortedStocks = [...stocks].sort((a, b) => b.change - a.change);
                const topGainers = sortedStocks.slice(0, config.topStocksCount);
                const topLosers = sortedStocks.slice(-config.topStocksCount).reverse();
                updateTopStocks('top-gainers', topGainers);
                updateTopStocks('top-losers', topLosers);
                updateTicker(stocks);
                
                // Обновляем градусник жадности
                const risingStocks = stocks.filter(stock => stock.change > 0).length;
                const totalStocks = stocks.length;
                updateGreedMeter(risingStocks, totalStocks);
            } catch (error) {
                console.error('Ошибка:', error);
                document.getElementById('ticker').innerHTML = 'Ошибка загрузки данных';
                document.getElementById('top-gainers').innerHTML = '<div class="list-item">-</div>';
                document.getElementById('top-losers').innerHTML = '<div class="list-item">-</div>';
            }
        }

        async function loadCurrencyRates() {
            try {
                const url = `https://www.cbr-xml-daily.ru/daily_json.js`;
                const response = await fetch(url);
                const data = await response.json();
                const updateDate = new Date(data.Date);
                const options = {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit', hour12: false
                };
                const formattedUpdateTime = updateDate.toLocaleString('ru-RU', options);
                document.getElementById('currency-update-time').textContent = `Обновлено: ${formattedUpdateTime}`;
                const usd = data.Valute.USD;
                const eur = data.Valute.EUR;
                const cny = data.Valute.CNY;
                currentRates.USD = usd.Value;
                currentRates.EUR = eur.Value;
                currentRates.CNY = cny.Value;
                const calculateChange = (current, previous) => ((current - previous) / previous * 100).toFixed(2);
                let currencyContent = '';
                const usdChange = calculateChange(usd.Value, usd.Previous);
                const usdChangeClass = usdChange > 0 ? 'up' : (usdChange < 0 ? 'down' : '');
                currencyContent += `
                    <div class="list-item">
                        <span class="list-name" title="Доллар США">USD</span>
                        <span class="list-value">${usd.Value.toFixed(2)} ₽</span>
                        <span class="list-change ${usdChangeClass}">${usdChange > 0 ? '+' : ''}${usdChange}%</span>
                    </div>
                `;
                const eurChange = calculateChange(eur.Value, eur.Previous);
                const eurChangeClass = eurChange > 0 ? 'up' : (eurChange < 0 ? 'down' : '');
                currencyContent += `
                    <div class="list-item">
                        <span class="list-name" title="Евро">EUR</span>
                        <span class="list-value">${eur.Value.toFixed(2)} ₽</span>
                        <span class="list-change ${eurChangeClass}">${eurChange > 0 ? '+' : ''}${eurChange}%</span>
                    </div>
                `;
                const cnyChange = calculateChange(cny.Value, cny.Previous);
                const cnyChangeClass = cnyChange > 0 ? 'up' : (cnyChange < 0 ? 'down' : '');
                currencyContent += `
                    <div class="list-item">
                        <span class="list-name" title="Китайский юань">CNY</span>
                        <span class="list-value">${cny.Value.toFixed(2)} ₽</span>
                        <span class="list-change ${cnyChangeClass}">${cnyChange > 0 ? '+' : ''}${cnyChange}%</span>
                    </div>
                `;
                document.getElementById('currency-rates').innerHTML = currencyContent;
            } catch (error) {
                console.error('Ошибка загрузки курсов валют:', error);
                document.getElementById('currency-rates').innerHTML = '<div class="list-item">Ошибка загрузки</div>';
                document.getElementById('currency-update-time').textContent = 'Ошибка обновления';
            }
        }

        async function loadCryptoRates() {
            try {
                const url = 'https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=bitcoin,ethereum,binancecoin,solana,ripple&price_change_percentage=24h';
                const response = await fetch(url);
                const data = await response.json();
                data.forEach(crypto => {
                    const symbol = crypto.symbol.toUpperCase();
                    if (currentCryptoRates[symbol]) {
                        currentCryptoRates[symbol].price = crypto.current_price;
                        currentCryptoRates[symbol].change = crypto.price_change_percentage_24h;
                    }
                });
                updateCryptoDisplay();
            } catch (error) {
                console.error('Ошибка загрузки криптовалют:', error);
                document.getElementById('crypto-rates').innerHTML = '<div class="list-item">Ошибка загрузки</div>';
            }
        }

        function updateCryptoDisplay() {
            const container = document.getElementById('crypto-rates');
            container.innerHTML = '';
            Object.entries(currentCryptoRates).forEach(([symbol, data]) => {
                const changeClass = data.change > 0 ? 'up' : (data.change < 0 ? 'down' : '');
                const changeSign = data.change > 0 ? '+' : '';
                const cryptoElement = document.createElement('div');
                cryptoElement.className = 'list-item';
                cryptoElement.innerHTML = `
                    <span class="list-name" title="${getCryptoName(symbol)}">${symbol}</span>
                    <span class="list-value">${data.price.toFixed(2)} $</span>
                    <span class="list-change ${changeClass}">${changeSign}${data.change.toFixed(2)}%</span>
                `;
                container.appendChild(cryptoElement);
            });
        }

        function getCryptoName(symbol) {
            const names = {
                'BTC': 'Bitcoin',
                'ETH': 'Ethereum',
                'BNB': 'Binance Coin',
                'SOL': 'Solana',
                'XRP': 'Ripple'
            };
            return names[symbol] || symbol;
        }

        function convertCurrency() {
            const amount = parseFloat(document.getElementById('converter-amount').value);
            if (isNaN(amount)) {
                document.getElementById('converter-result').textContent = 'Введите корректную сумму';
                return;
            }
            const fromCurrency = document.getElementById('converter-from').value;
            const toCurrency = document.getElementById('converter-to').value;
            if (fromCurrency === toCurrency) {
                document.getElementById('converter-result').textContent = 'Выберите разные валюты';
                return;
            }
            let result = 0;
            let resultText = '';
            if (['RUB', 'USD', 'EUR', 'CNY'].includes(fromCurrency) && ['RUB', 'USD', 'EUR', 'CNY'].includes(toCurrency)) {
                if (fromCurrency === 'RUB') {
                    if (toCurrency === 'USD') {
                        result = amount / currentRates.USD;
                        resultText = `${amount.toFixed(2)} RUB = ${result.toFixed(2)} USD`;
                    } else if (toCurrency === 'EUR') {
                        result = amount / currentRates.EUR;
                        resultText = `${amount.toFixed(2)} RUB = ${result.toFixed(2)} EUR`;
                    } else if (toCurrency === 'CNY') {
                        result = amount / currentRates.CNY;
                        resultText = `${amount.toFixed(2)} RUB = ${result.toFixed(2)} CNY`;
                    }
                } else if (toCurrency === 'RUB') {
                    if (fromCurrency === 'USD') {
                        result = amount * currentRates.USD;
                        resultText = `${amount.toFixed(2)} USD = ${result.toFixed(2)} RUB`;
                    } else if (fromCurrency === 'EUR') {
                        result = amount * currentRates.EUR;
                        resultText = `${amount.toFixed(2)} EUR = ${result.toFixed(2)} RUB`;
                    } else if (fromCurrency === 'CNY') {
                        result = amount * currentRates.CNY;
                        resultText = `${amount.toFixed(2)} CNY = ${result.toFixed(2)} RUB`;
                    }
                } else {
                    let rubAmount = 0;
                    if (fromCurrency === 'USD') {
                        rubAmount = amount * currentRates.USD;
                    } else if (fromCurrency === 'EUR') {
                        rubAmount = amount * currentRates.EUR;
                    } else if (fromCurrency === 'CNY') {
                        rubAmount = amount * currentRates.CNY;
                    }
                    if (toCurrency === 'USD') {
                        result = rubAmount / currentRates.USD;
                        resultText = `${amount.toFixed(2)} ${fromCurrency} = ${result.toFixed(2)} USD`;
                    } else if (toCurrency === 'EUR') {
                        result = rubAmount / currentRates.EUR;
                        resultText = `${amount.toFixed(2)} ${fromCurrency} = ${result.toFixed(2)} EUR`;
                    } else if (toCurrency === 'CNY') {
                        result = rubAmount / currentRates.CNY;
                        resultText = `${amount.toFixed(2)} ${fromCurrency} = ${result.toFixed(2)} CNY`;
                    }
                }
            } else {
                let usdAmount = 0;
                if (fromCurrency === 'USD') {
                    usdAmount = amount;
                } else if (fromCurrency === 'RUB') {
                    usdAmount = amount / currentRates.USD;
                } else if (fromCurrency === 'EUR') {
                    usdAmount = amount * (currentRates.USD / currentRates.EUR);
                } else if (fromCurrency === 'CNY') {
                    usdAmount = amount * (currentRates.USD / currentRates.CNY);
                } else if (['BTC', 'ETH', 'BNB', 'SOL', 'XRP'].includes(fromCurrency)) {
                    usdAmount = amount * currentCryptoRates[fromCurrency].price;
                }
                if (toCurrency === 'USD') {
                    result = usdAmount;
                    resultText = `${amount.toFixed(8)} ${fromCurrency} = ${result.toFixed(2)} USD`;
                } else if (toCurrency === 'RUB') {
                    result = usdAmount * currentRates.USD;
                    resultText = `${amount.toFixed(8)} ${fromCurrency} = ${result.toFixed(2)} RUB`;
                } else if (toCurrency === 'EUR') {
                    result = usdAmount * (currentRates.EUR / currentRates.USD);
                    resultText = `${amount.toFixed(8)} ${fromCurrency} = ${result.toFixed(2)} EUR`;
                } else if (toCurrency === 'CNY') {
                    result = usdAmount * (currentRates.CNY / currentRates.USD);
                    resultText = `${amount.toFixed(8)} ${fromCurrency} = ${result.toFixed(2)} CNY`;
                } else if (['BTC', 'ETH', 'BNB', 'SOL', 'XRP'].includes(toCurrency)) {
                    result = usdAmount / currentCryptoRates[toCurrency].price;
                    resultText = `${amount.toFixed(8)} ${fromCurrency} = ${result.toFixed(8)} ${toCurrency}`;
                }
            }
            document.getElementById('converter-result').textContent = resultText;
        }

        function updateTopStocks(elementId, stocks) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            stocks.forEach(stock => {
                const changeClass = stock.change > 0 ? 'up' : 'down';
                const changeSign = stock.change > 0 ? '+' : '';
                const volumeText = stock.volume ? formatNumber(stock.volume) + ' шт' : '-';
                const turnoverText = stock.turnover ? formatCurrency(stock.turnover) + ' ₽' : '-';
                
                const stockElement = document.createElement('div');
                stockElement.className = 'list-item';
                stockElement.innerHTML = `
                    <span class="list-name" title="${stock.name}">${stock.ticker}</span>
                    <span class="list-value">${stock.price.toFixed(2)} ₽</span>
                    <span class="list-change ${changeClass}">${changeSign}${stock.change.toFixed(2)}%</span>
                    <div class="volume-info">
                        <span title="Объем торгов">${volumeText}</span>
                        <span title="Оборот">${turnoverText}</span>
                    </div>
                `;
                container.appendChild(stockElement);
            });
        }

        function updateTicker(stocks) {
            let tickerContent = '';
            stocks.forEach(stock => {
                const changeClass = stock.change > 0 ? 'up' : (stock.change < 0 ? 'down' : '');
                tickerContent += `
                    <span class="ticker-item">
                        <span class="ticker-name">${stock.ticker}</span>
                        ${stock.price ? stock.price.toFixed(2) + ' ₽' : '-'}
                        <span class="${changeClass}">
                            ${stock.change ? (stock.change > 0 ? '+' : '') + stock.change.toFixed(2) + '%' : ''}
                        </span>
                        <span style="color: #aaa; font-size: 0.9em; margin-left: 5px;">
                            ${stock.volume ? formatNumber(stock.volume) + ' шт' : ''}
                        </span>
                    </span>
                `;
            });
            document.getElementById('ticker').innerHTML = tickerContent;
            adjustAnimationSpeed();
        }

        function formatNumber(num) {
            if (num >= 1000000000) return (num / 1000000000).toFixed(1) + ' млрд';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + ' млн';
            if (num >= 1000) return (num / 1000).toFixed(1) + ' тыс';
            return num.toString();
        }
        function formatCurrency(amount) {
            if (amount >= 1000000000) return (amount / 1000000000).toFixed(1) + ' млрд';
            if (amount >= 1000000) return (amount / 1000000).toFixed(1) + ' млн';
            if (amount >= 1000) return (amount / 1000).toFixed(1) + ' тыс';
            return amount.toFixed(2);
        }

        function adjustAnimationSpeed() {
            const ticker = document.getElementById('ticker');
            const itemsCount = ticker.querySelectorAll('.ticker-item').length;
            const duration = Math.max(120, itemsCount * 2);
            ticker.style.animationDuration = `${duration}s`;
        }

        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            panel.classList.toggle('collapsed');
            const isCollapsed = panel.classList.contains('collapsed');
            localStorage.setItem(`${panelId}-collapsed`, isCollapsed);
        }

        function initPanels() {
            const panels = ['currency-converter-block', 'top-stocks-block', 'currency-rates-block', 'crypto-block'];
            panels.forEach(panelId => {
                const isCollapsed = localStorage.getItem(`${panelId}-collapsed`) === 'true';
                const panel = document.getElementById(panelId);
                if (isCollapsed) panel.classList.add('collapsed');
            });
            if (window.innerWidth <= 768) {
                panels.forEach(panelId => {
                    if (!localStorage.getItem(`${panelId}-collapsed`)) {
                        const panel = document.getElementById(panelId);
                        panel.classList.add('collapsed');
                    }
                });
            }
        }

        updateWorldTime();
        setInterval(updateWorldTime, 1000);
        loadData();
        setInterval(loadData, config.updateInterval);
        loadCurrencyRates();
        setInterval(loadCurrencyRates, 4 * 60 * 60 * 1000);
        loadCryptoRates();
        setInterval(loadCryptoRates, 5 * 60 * 1000);

        document.getElementById('converter-amount').addEventListener('input', convertCurrency);
        document.getElementById('converter-from').addEventListener('change', convertCurrency);
        document.getElementById('converter-to').addEventListener('change', convertCurrency);

        window.addEventListener('load', initPanels);
        
        // Функция для обновления SVG-градусника
        function updateGreedMeter(rising, total) {
            const percent = total > 0 ? Math.round(rising / total * 100) : 0;
            // Новый диапазон: 0% = 180° (лево), 100% = 360° (право)
            const minAngle = 180;
            const maxAngle = 360;
            const angle = minAngle + (maxAngle - minAngle) * (percent / 100);
            const rad = angle * Math.PI / 180;
            // Центр: (160, 160), длина стрелки: 118
            const cx = 160, cy = 160, len = 118;
            const x2 = cx + len * Math.cos(rad);
            const y2 = cy + len * Math.sin(rad);
            const arrow = document.getElementById('greed-arrow');
            if (arrow) {
                arrow.innerHTML = `
                    <line x1="160" y1="160" x2="${x2}" y2="${y2}" stroke="#fff" stroke-width="7" stroke-linecap="round"/>
                    <circle cx="160" cy="160" r="13" fill="#222" stroke="#fff" stroke-width="4"/>
                    <text x="160" y="166" text-anchor="middle" font-size="15" fill="#fff" font-family="Arial">%</text>
                `;
            }
            // Обновляем только цвет и текстовую метку
            const label = document.getElementById('greed-label');
            if (label) {
                if (percent < 15) {
                    label.textContent = 'Экстремальный страх';
                    label.style.color = '#d32f2f';
                } else if (percent < 30) {
                    label.textContent = 'Страх';
                    label.style.color = '#F44336';
                } else if (percent < 60) {
                    label.textContent = 'Нейтрально';
                    label.style.color = '#FFEB3B';
                } else if (percent < 85) {
                    label.textContent = 'Жадность';
                    label.style.color = '#4CAF50';
                } else {
                    label.textContent = 'Экстремальная жадность';
                    label.style.color = '#388e3c';
                }
            }
        }
        
        // Обработчик клика по градуснику для открытия модального окна
        document.addEventListener('DOMContentLoaded', function() {
            const greedMeter = document.getElementById('greed-meter');
            const greedModal = document.getElementById('greed-modal');
            const closeGreedModal = document.getElementById('close-greed-modal');
            
            if (greedMeter) {
                greedMeter.addEventListener('click', function() {
                    if (greedModal) {
                        greedModal.style.display = 'flex';
                    }
                });
            }
            
            if (closeGreedModal) {
                closeGreedModal.addEventListener('click', function() {
                    if (greedModal) {
                        greedModal.style.display = 'none';
                    }
                });
            }
            
            // Закрытие модального окна при клике вне его
            if (greedModal) {
                greedModal.addEventListener('click', function(e) {
                    if (e.target === greedModal) {
                        greedModal.style.display = 'none';
                    }
                });
            }
        });
    </script>
    <div id="bybit-news-drawer" style="position: fixed; left: 0; right: 0; bottom: -100%; background: #252525; color: #fff; box-shadow: 0 -4px 24px rgba(0,0,0,0.25); border-top-left-radius: 18px; border-top-right-radius: 18px; border-top: 1.5px solid #333; max-height: 70vh; min-height: 200px; z-index: 9999; transition: bottom 0.4s cubic-bezier(.4,1.4,.6,1); overflow-y: auto; padding: 0;">
        <div style="padding: 12px 18px; display: flex; justify-content: space-between; align-items: center;">
            <span style="font-weight:bold; font-size:1.1em; color:#8BC34A;">Листинги Bybit</span>
            <button id="bybit-news-close" style="background:none;border:none;color:#fff;font-size:1.5em;cursor:pointer;">×</button>
        </div>
        <div id="bybit-news-content" style="padding: 0 18px 18px 18px;">
            <div style="text-align:center;color:#aaa;">Загрузка новостей...</div>
        </div>
    </div>
    <script>
    document.getElementById('bybit-news-btn').onclick = function(e) {
        e.preventDefault();
        const drawer = document.getElementById('bybit-news-drawer');
        drawer.style.bottom = '0';
        loadBybitNews();
    };
    document.getElementById('bybit-news-close').onclick = function() {
        document.getElementById('bybit-news-drawer').style.bottom = '-100%';
    };

    async function loadBybitNews() {
        const root = document.getElementById('bybit-news-content');
        root.innerHTML = '<div style="text-align:center;color:#aaa;">Загрузка новостей...</div>';
        try {
            const resp = await fetch('https://api.bybit.com/v5/announcements/index?locale=ru-RU&limit=20');
            const data = await resp.json();
            if (!data.result || !data.result.list || !data.result.list.length) {
                root.innerHTML = '<div style="text-align:center;color:#aaa;">Нет новостей</div>';
                return;
            }
            const news = data.result.list.filter(
                ann => ann.type && (ann.type.key === 'new_crypto' || ann.type.key === 'delisting')
            );
            news.sort((a, b) => (b.dateTimestamp || b.publishTime || 0) - (a.dateTimestamp || a.publishTime || 0));
            if (!news.length) {
                root.innerHTML = '<div style="text-align:center;color:#aaa;">Нет свежих листингов или делистингов</div>';
                return;
            }
            let html = '<ul style="list-style:none;padding:0;margin:0;">';
            for (const ann of news) {
                const dt = new Date(ann.dateTimestamp || ann.publishTime || 0);
                html += `
                    <li style="background:#252525;border-radius:8px;margin-bottom:14px;padding:12px 10px;box-shadow:0 2px 8px rgba(0,0,0,0.10);">
                        <div style="font-size:0.95em;color:#b0b0b0;margin-bottom:4px;">
                            ${dt.toLocaleString('ru-RU', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'})}
                        </div>
                        <div style="font-size:1.08em;font-weight:bold;margin-bottom:4px;color:#fff;">${ann.title}</div>
                        <div style="font-size:1em;color:#e0e0e0;margin-bottom:6px;">${ann.description}</div>
                        <a href="${ann.url}" target="_blank" style="color:#8BC34A;text-decoration:underline;font-size:0.98em;">Подробнее</a>
                    </li>
                `;
            }
            html += '</ul>';
            root.innerHTML = html;
        } catch (e) {
            root.innerHTML = '<div style="text-align:center;color:#aaa;">Ошибка загрузки новостей</div>';
        }
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    
    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
        (function(m,e,t,r,i,k,a){
            m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
            m[i].l=1*new Date();
            for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
            k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
        })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=103490917', 'ym');

        ym(103490917, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
    </script>
    <noscript><div><img src="https://mc.yandex.ru/watch/103490917" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
    <!-- /Yandex.Metrika counter -->
</body>
</html>

