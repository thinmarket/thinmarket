<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –û–ø—Ü–∏–æ–Ω–æ–≤ - –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ê–Ω–æ–º–∞–ª–∏–∏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #232323;
            color: #fff;
        }
        .container {
            background: #2E2E2E;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.18);
            margin-bottom: 25px;
        }
        h1 {
            color: #4CAF50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        h2, h3 {
            color: #fff;
        }
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #4CAF50;
            font-size: 16px;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 8px;
            font-size: 16px;
            background: #181818;
            color: #fff;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            border-color: #4CAF50;
            outline: none;
        }
        button {
            background: linear-gradient(135deg, #4CAF50, #2980b9);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px;
            font-weight: bold;
            transition: transform 0.2s, background 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #2980b9, #4CAF50);
        }
        .results-container {
            margin-top: 25px;
        }
        .volatility-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .volatility-card {
            background: #232323;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.18);
            border-left: 6px solid #3498db;
        }
        .volatility-card.low-vol {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #1b2e1b, #232323);
        }
        .volatility-card.medium-vol {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #2e2a1b, #232323);
        }
        .volatility-card.high-vol {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #2e1b1b, #232323);
        }
        .volatility-card.anomaly {
            border-left-color: #9b59b6;
            background: linear-gradient(135deg, #2e1b2e, #232323);
        }
        .volatility-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .option-title {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }
        .volatility-score {
            background: #181818;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
        }
        .score-low { color: #27ae60; }
        .score-medium { color: #f39c12; }
        .score-high { color: #e74c3c; }
        .score-anomaly { color: #9b59b6; }
        .volatility-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .volatility-item {
            text-align: center;
            padding: 10px;
            background: #181818;
            border-radius: 8px;
        }
        .volatility-value {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
        }
        .volatility-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .volatility-status {
            font-weight: bold;
            font-size: 14px;
            margin-top: 10px;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }
        .status-low {
            background: #1b2e1b;
            color: #27ae60;
        }
        .status-medium {
            background: #2e2a1b;
            color: #f39c12;
        }
        .status-high {
            background: #2e1b1b;
            color: #e74c3c;
        }
        .status-anomaly {
            background: #2e1b2e;
            color: #9b59b6;
        }
        .stats-bar {
            background: #181818;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            color: #fff;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            background: #232323;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.10);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #4CAF50;
        }
        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .warning-box {
            background: #2e1b1b;
            border: 1px solid #e74c3c;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #e74c3c;
        }
        .info-box {
            background: #1b2e1b;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #27ae60;
        }
        .strategy-box {
            background: #1b2e1b;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            color: #27ae60;
        }
    </style>
</head>
<body>
    <h1>üìà –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –û–ø—Ü–∏–æ–Ω–æ–≤ - –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ê–Ω–æ–º–∞–ª–∏–∏</h1>
    
    <div class="container">
        <h2>üéØ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏</h2>
        
        <div class="filters">
            <div class="input-group">
                <label for="assetCode">–ö–æ–¥ –±–∞–∑–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞:</label>
                <input type="text" id="assetCode" value="CNY" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: CNY, SI, SBER">
            </div>
            
            <div class="input-group">
                <label for="optionType">–¢–∏–ø –æ–ø—Ü–∏–æ–Ω–∞:</label>
                <select id="optionType">
                    <option value="call">CALL (–ö–æ–ª–ª)</option>
                    <option value="put">PUT (–ü—É—Ç)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="minDays">–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏ (–¥–Ω–µ–π):</label>
                <input type="number" id="minDays" value="7" min="0" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ –≤—Ä–µ–º–µ–Ω–∏">
            </div>
            
            <div class="input-group">
                <label for="volatilityThreshold">–ü–æ—Ä–æ–≥ –∞–Ω–æ–º–∞–ª—å–Ω–æ–π –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (%):</label>
                <input type="number" id="volatilityThreshold" value="70" min="0" placeholder="–ü–æ—Ä–æ–≥ –¥–ª—è –∞–Ω–æ–º–∞–ª–∏–π">
            </div>
        </div>
        
        <button onclick="analyzeVolatility()">üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</button>
        
        <div class="info-box">
            <strong>üí° –ê–Ω–∞–ª–∏–∑ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏:</strong> 
            <ul>
                <li><strong>–ù–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</strong> - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏ –æ–ø—Ü–∏–æ–Ω–æ–≤ –¥–µ—à–µ–≤–æ</li>
                <li><strong>–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</strong> - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–∞–∂–∏ –æ–ø—Ü–∏–æ–Ω–æ–≤ –¥–æ—Ä–æ–≥–æ</li>
                <li><strong>–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</strong> - –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏</li>
                <li><strong>–ü—Ä–æ–≥–Ω–æ–∑</strong> - –æ–∂–∏–¥–∞–µ–º–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥—Ä–µ–∫–æ–≤</li>
            </ul>
        </div>
        
        <div id="stats" class="stats-bar" style="display: none;"></div>
        <div id="results" class="results-container" style="display: none;"></div>
    </div>

    <script>
        let allVolatilityData = [];

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –æ–ø—Ü–∏–æ–Ω–∞
        function getOptionType(data) {
            if (data.option_type) {
                return data.option_type.toLowerCase();
            }
            const secid = data.secid || data;
            const lastBIndex = secid.lastIndexOf('B');
            const lastUIndex = secid.lastIndexOf('U');
            return lastBIndex > lastUIndex ? 'call' : 'put';
        }

        async function makeRequest(url) {
            try {
                const response = await fetch(url);
                const data = await response.json();
                return { status: response.status, data: data };
            } catch (error) {
                return { status: 'ERROR', data: { error: error.message } };
            }
        }

        function calculateVolatilityAnalysis(data) {
            const volatility = data.volatility || 0;
            const delta = Math.abs(data.delta || 0);
            const gamma = Math.abs(data.gamma || 0);
            const vega = Math.abs(data.vega || 0);
            const theta = Math.abs(data.theta || 0);
            const daysToExpiry = data.days_until_expiring || 0;
            const theorPrice = data.theorprice || 0;
            const underlyingPrice = data.underlying_price || 1;
            
            let analysis = {
                currentVolatility: volatility,
                volatilityCategory: '',
                volatilityScore: 0,
                anomalyScore: 0,
                forecast: '',
                strategy: '',
                reasons: [],
                riskLevel: '',
                opportunity: ''
            };

            // –ö–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
            if (volatility < 20) {
                analysis.volatilityCategory = 'low';
                analysis.volatilityScore = 25;
                analysis.reasons.push("‚úÖ –û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å - –æ–ø—Ü–∏–æ–Ω—ã –¥–µ—à–µ–≤—ã–µ");
                analysis.opportunity = "–ü–æ–∫—É–ø–∫–∞ –æ–ø—Ü–∏–æ–Ω–æ–≤ –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ —Ä–æ—Å—Ç–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏";
            } else if (volatility < 40) {
                analysis.volatilityCategory = 'low-medium';
                analysis.volatilityScore = 20;
                analysis.reasons.push("‚úÖ –ù–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å - —É–º–µ—Ä–µ–Ω–Ω—ã–µ —Ü–µ–Ω—ã");
                analysis.opportunity = "–°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º —Ä–∏—Å–∫–æ–º";
            } else if (volatility < 60) {
                analysis.volatilityCategory = 'medium';
                analysis.volatilityScore = 15;
                analysis.reasons.push("‚úÖ –£–º–µ—Ä–µ–Ω–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—Å–ª–æ–≤–∏—è");
                analysis.opportunity = "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏";
            } else if (volatility < 80) {
                analysis.volatilityCategory = 'high';
                analysis.volatilityScore = 10;
                analysis.reasons.push("‚ö†Ô∏è –í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å - –¥–æ—Ä–æ–≥–∏–µ –æ–ø—Ü–∏–æ–Ω—ã");
                analysis.opportunity = "–ü—Ä–æ–¥–∞–∂–∞ –æ–ø—Ü–∏–æ–Ω–æ–≤ –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ –ø–∞–¥–µ–Ω–∏—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏";
            } else {
                analysis.volatilityCategory = 'very-high';
                analysis.volatilityScore = 5;
                analysis.reasons.push("‚ùå –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å - —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ —Ü–µ–Ω—ã");
                analysis.opportunity = "–ü—Ä–æ–¥–∞–∂–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏, –∑–∞—â–∏—Ç–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏";
            }

            // –ê–Ω–∞–ª–∏–∑ –∞–Ω–æ–º–∞–ª–∏–π
            const volatilityThreshold = parseInt(document.getElementById('volatilityThreshold').value) || 70;
            if (volatility > volatilityThreshold) {
                analysis.anomalyScore = 30;
                analysis.reasons.push("üö® –ê–ù–û–ú–ê–õ–¨–ù–ê–Ø –í–û–õ–ê–¢–ò–õ–¨–ù–û–°–¢–¨ - —Ç–æ—Ä–≥–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏!");
            }

            // –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥—Ä–µ–∫–æ–≤
            if (vega > 0.1 && gamma > 0.01) {
                analysis.forecast = "üìà –û–∂–∏–¥–∞–µ—Ç—Å—è —Ä–æ—Å—Ç –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (–≤—ã—Å–æ–∫–∏–µ Vega/Gamma)";
                analysis.strategy = "Long Straddle/Strangle, –ø–æ–∫—É–ø–∫–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏";
            } else if (vega < 0.05 && gamma < 0.005) {
                analysis.forecast = "üìâ –û–∂–∏–¥–∞–µ—Ç—Å—è –ø–∞–¥–µ–Ω–∏–µ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ (–Ω–∏–∑–∫–∏–µ Vega/Gamma)";
                analysis.strategy = "Short Straddle/Strangle, –ø—Ä–æ–¥–∞–∂–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏";
            } else {
                analysis.forecast = "‚û°Ô∏è –°—Ç–∞–±–∏–ª—å–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å";
                analysis.strategy = "–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, Iron Condor";
            }

            // –ê–Ω–∞–ª–∏–∑ —Ä–∏—Å–∫–∞
            if (theta > 0.1 && daysToExpiry < 30) {
                analysis.riskLevel = "–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∑–∞—Ç—É—Ö–∞–Ω–∏—è";
                analysis.reasons.push("‚ö†Ô∏è –ë—ã—Å—Ç—Ä–æ–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ (Theta)");
            } else if (delta > 0.8 || delta < 0.2) {
                analysis.riskLevel = "–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è Delta - –≤—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫";
                analysis.reasons.push("‚ö†Ô∏è –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è Delta - –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è");
            } else {
                analysis.riskLevel = "–£–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫";
            }

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç–æ—Ä—ã
            const priceRatio = theorPrice / underlyingPrice;
            if (priceRatio < 0.01) {
                analysis.reasons.push("üí° –û—á–µ–Ω—å –¥–µ—à–µ–≤—ã–π –æ–ø—Ü–∏–æ–Ω - –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞");
            } else if (priceRatio > 0.2) {
                analysis.reasons.push("üí° –î–æ—Ä–æ–≥–æ–π –æ–ø—Ü–∏–æ–Ω - –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–∞–¥–µ–Ω–∏—è");
            }

            return analysis;
        }

        function getVolatilityStatus(analysis) {
            if (analysis.anomalyScore > 0) {
                return {
                    class: 'anomaly',
                    status: 'üö® –ê–ù–û–ú–ê–õ–¨–ù–ê–Ø –í–û–õ–ê–¢–ò–õ–¨–ù–û–°–¢–¨',
                    description: '–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏'
                };
            } else if (analysis.currentVolatility < 30) {
                return {
                    class: 'low-vol',
                    status: '–ù–ò–ó–ö–ê–Ø –í–û–õ–ê–¢–ò–õ–¨–ù–û–°–¢–¨',
                    description: '–î–µ—à–µ–≤—ã–µ –æ–ø—Ü–∏–æ–Ω—ã, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞'
                };
            } else if (analysis.currentVolatility < 60) {
                return {
                    class: 'medium-vol',
                    status: '–£–ú–ï–†–ï–ù–ù–ê–Ø –í–û–õ–ê–¢–ò–õ–¨–ù–û–°–¢–¨',
                    description: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—Å–ª–æ–≤–∏—è —Ç–æ—Ä–≥–æ–≤–ª–∏'
                };
            } else {
                return {
                    class: 'high-vol',
                    status: '–í–´–°–û–ö–ê–Ø –í–û–õ–ê–¢–ò–õ–¨–ù–û–°–¢–¨',
                    description: '–î–æ—Ä–æ–≥–∏–µ –æ–ø—Ü–∏–æ–Ω—ã, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª –ø–∞–¥–µ–Ω–∏—è'
                };
            }
        }

        async function analyzeVolatility() {
            const assetCode = document.getElementById('assetCode').value.trim();
            const optionType = document.getElementById('optionType').value;
            const minDays = parseInt(document.getElementById('minDays').value) || 0;
            
            if (!assetCode) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –±–∞–∑–æ–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('results').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –æ–ø—Ü–∏–æ–Ω–æ–≤ –Ω–∞ ${assetCode}...
                </div>
            `;
            document.getElementById('results').style.display = 'block';
            document.getElementById('stats').style.display = 'none';
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –æ–ø—Ü–∏–æ–Ω–æ–≤
            const optionsUrl = `https://iss.moex.com/iss/apps/option-calc/v1/assets/${assetCode}/options`;
            const optionsResult = await makeRequest(optionsUrl);
            
            if (optionsResult.status !== 200) {
                document.getElementById('results').innerHTML = `
                    <h3>‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –æ–ø—Ü–∏–æ–Ω–æ–≤</h3>
                    <p>–°—Ç–∞—Ç—É—Å: ${optionsResult.status}</p>
                    <p>–û—à–∏–±–∫–∞: ${optionsResult.data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                `;
                return;
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –æ–ø—Ü–∏–æ–Ω—ã –ø–æ —Ç–∏–ø—É
            const filteredOptions = optionsResult.data.filter(option => {
                const optionTypeFromAPI = option.option_type ? option.option_type.toLowerCase() : null;
                
                if (optionTypeFromAPI) {
                    return optionTypeFromAPI === optionType;
                } else {
                    const optionTypeFromSecid = getOptionType(option.secid);
                    return optionTypeFromSecid === optionType;
                }
            });
            
            console.log(`–ù–∞–π–¥–µ–Ω–æ ${filteredOptions.length} ${optionType.toUpperCase()} –æ–ø—Ü–∏–æ–Ω–æ–≤`);
            
            // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å –∫–∞–∂–¥–æ–≥–æ –æ–ø—Ü–∏–æ–Ω–∞
            allVolatilityData = [];
            let processedCount = 0;
            
            for (const option of filteredOptions) {
                const detailUrl = `https://iss.moex.com/iss/apps/option-calc/v1/assets/${assetCode}/options/${option.secid}`;
                const detailResult = await makeRequest(detailUrl);
                
                if (detailResult.status === 200) {
                    const volatilityAnalysis = calculateVolatilityAnalysis(detailResult.data);
                    const volatilityStatus = getVolatilityStatus(volatilityAnalysis);
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ –¥–æ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏
                    if (detailResult.data.days_until_expiring >= minDays) {
                        allVolatilityData.push({
                            ...detailResult.data,
                            volatility: volatilityAnalysis,
                            status: volatilityStatus
                        });
                    }
                }
                
                processedCount++;
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                if (processedCount % 10 === 0) {
                    document.getElementById('results').innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processedCount} –∏–∑ ${filteredOptions.length} –æ–ø—Ü–∏–æ–Ω–æ–≤...
                        </div>
                    `;
                }
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∞–Ω–æ–º–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
            allVolatilityData.sort((a, b) => {
                // –°–Ω–∞—á–∞–ª–∞ –∞–Ω–æ–º–∞–ª–∏–∏, –ø–æ—Ç–æ–º –ø–æ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏
                if (a.volatility.anomalyScore > 0 && b.volatility.anomalyScore === 0) return -1;
                if (a.volatility.anomalyScore === 0 && b.volatility.anomalyScore > 0) return 1;
                return b.volatility.currentVolatility - a.volatility.currentVolatility;
            });
            
            displayVolatilityResults();
        }

        function displayVolatilityResults() {
            const assetCode = document.getElementById('assetCode').value.trim();
            const optionType = document.getElementById('optionType').value;
            const minDays = parseInt(document.getElementById('minDays').value) || 0;
            
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            const totalOptions = allVolatilityData.length;
            const anomalies = allVolatilityData.filter(o => o.volatility.anomalyScore > 0).length;
            const lowVol = allVolatilityData.filter(o => o.volatility.currentVolatility < 30).length;
            const highVol = allVolatilityData.filter(o => o.volatility.currentVolatility > 60).length;
            const avgVol = allVolatilityData.reduce((sum, o) => sum + o.volatility.currentVolatility, 0) / totalOptions;
            
            let statsHtml = `
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${totalOptions}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –æ–ø—Ü–∏–æ–Ω–æ–≤ (–¥–Ω–µ–π ‚â• ${minDays})</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #9b59b6;">${anomalies}</div>
                        <div class="stat-label">–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #27ae60;">${lowVol}</div>
                        <div class="stat-label">–ù–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (<30%)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #e74c3c;">${highVol}</div>
                        <div class="stat-label">–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å (>60%)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${avgVol.toFixed(1)}%</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω—è—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</div>
                    </div>
                </div>
            `;
            
            document.getElementById('stats').innerHTML = statsHtml;
            document.getElementById('stats').style.display = 'block';
            
            // –°–ø–∏—Å–æ–∫ –æ–ø—Ü–∏–æ–Ω–æ–≤
            let resultsHtml = `
                <h3>üèÜ –ê–Ω–∞–ª–∏–∑ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –æ–ø—Ü–∏–æ–Ω–æ–≤ ${assetCode} ${optionType.toUpperCase()}</h3>
                <div class="info-box">
                    <strong>üí° –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏ –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å—é:</strong><br>
                    ‚Ä¢ <strong>–ù–∏–∑–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</strong> ‚Üí Long Straddle/Strangle (–æ–∂–∏–¥–∞–Ω–∏–µ —Ä–æ—Å—Ç–∞)<br>
                    ‚Ä¢ <strong>–í—ã—Å–æ–∫–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</strong> ‚Üí Short Straddle/Strangle (–æ–∂–∏–¥–∞–Ω–∏–µ –ø–∞–¥–µ–Ω–∏—è)<br>
                    ‚Ä¢ <strong>–ê–Ω–æ–º–∞–ª—å–Ω–∞—è –≤–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</strong> ‚Üí –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏
                </div>
                <div class="volatility-grid">
            `;
            
            allVolatilityData.forEach((option, index) => {
                const scoreClass = option.volatility.anomalyScore > 0 ? 'score-anomaly' : 
                                 option.volatility.currentVolatility < 30 ? 'score-low' : 
                                 option.volatility.currentVolatility < 60 ? 'score-medium' : 'score-high';
                const statusClass = option.status.class;
                const statusTextClass = `status-${option.status.class.replace('-vol', '')}`;
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –ø–æ–≥–∞—à–µ–Ω–∏—è
                const expirationDate = option.expiring_date ? 
                    new Date(option.expiring_date).toLocaleDateString('ru-RU', { 
                        day: '2-digit', 
                        month: '2-digit', 
                        year: '2-digit' 
                    }) : 'N/A';
                
                resultsHtml += `
                    <div class="volatility-card ${statusClass}">
                        <div class="volatility-header">
                            <div class="option-title">#${index + 1} ${option.secid} <span style="color: #7f8c8d; font-size: 14px;">(${expirationDate})</span></div>
                            <div class="volatility-score ${scoreClass}">${option.volatility.currentVolatility.toFixed(1)}%</div>
                        </div>
                        
                        <div class="volatility-details">
                            <div class="volatility-item">
                                <div class="volatility-value">${option.volatility.currentVolatility.toFixed(1)}%</div>
                                <div class="volatility-label">–í–æ–ª–∞—Ç–∏–ª—å–Ω–æ—Å—Ç—å</div>
                            </div>
                            <div class="volatility-item">
                                <div class="volatility-value">${Math.abs(option.delta || 0).toFixed(3)}</div>
                                <div class="volatility-label">Delta</div>
                            </div>
                            <div class="volatility-item">
                                <div class="volatility-value">${Math.abs(option.vega || 0).toFixed(3)}</div>
                                <div class="volatility-label">Vega</div>
                            </div>
                            <div class="volatility-item">
                                <div class="volatility-value">${Math.abs(option.gamma || 0).toFixed(4)}</div>
                                <div class="volatility-label">Gamma</div>
                            </div>
                        </div>
                        
                        <div class="volatility-status ${statusTextClass}">
                            ${option.status.status}
                        </div>
                        
                        <div class="strategy-box">
                            <strong>üìà –ü—Ä–æ–≥–Ω–æ–∑:</strong> ${option.volatility.forecast}<br>
                            <strong>üéØ –°—Ç—Ä–∞—Ç–µ–≥–∏—è:</strong> ${option.volatility.strategy}<br>
                            <strong>üí° –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å:</strong> ${option.volatility.opportunity}
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">
                            <strong>–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:</strong><br>
                            ${option.volatility.reasons.slice(0, 2).join(', ')}
                        </div>
                    </div>
                `;
            });
            
            resultsHtml += '</div>';
            
            if (allVolatilityData.length === 0) {
                resultsHtml = `
                    <div class="info-box">
                        <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h3>
                        <p><strong>–ù–µ –Ω–∞–π–¥–µ–Ω–æ –æ–ø—Ü–∏–æ–Ω–æ–≤</strong> —Å –≤—Ä–µ–º–µ–Ω–µ–º –¥–æ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏ ‚â• ${minDays} –¥–Ω–µ–π.</p>
                        <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:</p>
                        <ul>
                            <li>–£–º–µ–Ω—å—à–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–æ —ç–∫—Å–ø–∏—Ä–∞—Ü–∏–∏</li>
                            <li>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥—Ä—É–≥–æ–π –±–∞–∑–æ–≤—ã–π –∞–∫—Ç–∏–≤</li>
                            <li>–í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π —Ç–∏–ø –æ–ø—Ü–∏–æ–Ω–∞</li>
                        </ul>
                    </div>
                `;
            }
            
            document.getElementById('results').innerHTML = resultsHtml;
        }
    </script>
</body>
</html>