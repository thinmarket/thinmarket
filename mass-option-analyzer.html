<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Массовый Анализатор Опционов - Рейтинг и Выбор</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #232323;
            color: #fff;
        }
        .container {
            background: #2E2E2E;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.18);
            margin-bottom: 25px;
        }
        h1 {
            color: #4CAF50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        h2, h3 {
            color: #fff;
        }
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #4CAF50;
            font-size: 16px;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #444;
            border-radius: 8px;
            font-size: 16px;
            background: #181818;
            color: #fff;
            box-sizing: border-box;
        }
        input:focus, select:focus {
            border-color: #4CAF50;
            outline: none;
        }
        button {
            background: linear-gradient(135deg, #4CAF50, #2980b9);
            color: white;
            padding: 15px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 8px;
            font-weight: bold;
            transition: transform 0.2s, background 0.2s;
            width: 100%;
        }
        button:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #2980b9, #4CAF50);
        }
        .results-container {
            margin-top: 25px;
        }
        .options-list {
            display: grid;
            gap: 15px;
        }
        .option-card {
            background: #232323;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.18);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 6px solid #3498db;
        }
        .option-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(76,175,80,0.18);
        }
        .option-card.excellent {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #1b2e1b, #232323);
        }
        .option-card.good {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #2e2a1b, #232323);
        }
        .option-card.poor {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #2e1b1b, #232323);
        }
        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .option-title {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }
        .option-score {
            background: #181818;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 18px;
        }
        .score-excellent { color: #27ae60; }
        .score-good { color: #f39c12; }
        .score-poor { color: #e74c3c; }
        .option-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .detail-item {
            text-align: center;
            padding: 10px;
            background: #181818;
            border-radius: 8px;
        }
        .detail-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }
        .detail-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .option-recommendation {
            font-weight: bold;
            font-size: 16px;
            margin-top: 10px;
        }
        .recommendation-buy { color: #27ae60; }
        .recommendation-hold { color: #f39c12; }
        .recommendation-sell { color: #e74c3c; }
        
        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow-y: auto;
        }
        .modal-content {
            background: #232323;
            margin: 20px auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 1200px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            color: #fff;
        }
        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        .close:hover {
            color: #fff;
        }
        .modal-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        .modal-subtitle {
            color: #bbb;
            font-size: 16px;
        }
        
        /* Стили для детального анализа в модалке */
        .trade-recommendation {
            background: linear-gradient(135deg, #232323, #1b2e1b);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #27ae60;
            color: #27ae60;
        }
        .recommendation-buy {
            background: linear-gradient(135deg, #1b2e1b, #232323);
            border-color: #27ae60;
        }
        .recommendation-hold {
            background: linear-gradient(135deg, #2e2a1b, #232323);
            border-color: #f39c12;
            color: #f39c12;
        }
        .recommendation-sell {
            background: linear-gradient(135deg, #2e1b1b, #232323);
            border-color: #e74c3c;
            color: #e74c3c;
        }
        .score-card {
            background: #181818;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.12);
        }
        .score-bar {
            background: #333;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        .score-fill {
            height: 100%;
            transition: width 0.5s;
            border-radius: 15px;
        }
        .score-excellent { background: linear-gradient(90deg, #27ae60, #2ecc71); 
            color: white; /* Белый текст для зеленого фона */
        }
        .score-good { background: linear-gradient(90deg, #f39c12, #f1c40f); 
            color: black; /* Черный текст для желтого/оранжевого фона */
        }
        .score-poor { background: linear-gradient(90deg, #e74c3c, #c0392b); 
            color: white; /* Белый текст для красного фона */
        }
        .price-analysis {
            background: #181818;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .price-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .price-item {
            background: #232323;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.10);
        }
        .price-value {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }
        .price-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .pros-cons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .pros, .cons {
            padding: 15px;
            border-radius: 8px;
        }
        .pros {
            background: #1b2e1b;
            border-left: 4px solid #27ae60;
        }
        .cons {
            background: #2e1b1b;
            border-left: 4px solid #e74c3c;
        }
        .pros h4, .cons h4 {
            margin-top: 0;
            color: #fff;
        }
        .pros ul, .cons ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .pros li, .cons li {
            margin: 5px 0;
            line-height: 1.4;
        }
        .analysis-section {
            background: #181818;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        .analysis-section h3 {
            color: #4CAF50;
            margin-top: 0;
            font-size: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #4CAF50;
        }
        .spinner {
            border: 4px solid #333;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stats-bar {
            background: #181818;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            color: #fff;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-item {
            background: #232323;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.10);
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        /* Информационные и предупреждающие блоки */
        .info-box {
            background: #181818;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #4CAF50;
        }
        .warning-box {
            background: #2e1b1b;
            border: 1px solid #e74c3c;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <h1> Массовый Анализатор Опционов - Рейтинг и Выбор</h1>
    
    <div class="container">
        <h2>🎯 Настройки анализа</h2>
        
        <div class="filters">
            <div class="input-group">
                <label for="assetCode">Код базового актива:</label>
                <input type="text" id="assetCode" value="CNY" placeholder="Например: CNY, SI, SBER">
            </div>
            
            <div class="input-group">
                <label for="optionType">Тип опциона:</label>
                <select id="optionType">
                    <option value="call">CALL (Колл)</option>
                    <option value="put">PUT (Пут)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="tradeType">Тип сделки:</label>
                <select id="tradeType">
                    <option value="buy">ПОКУПКА</option>
                    <option value="sell">ПРОДАЖА</option>
                </select>
            </div>
        </div>
        
        <button onclick="analyzeAllOptions()">🔍 Анализировать все опционы</button>
        
        <div id="stats" class="stats-bar" style="display: none;"></div>
        <div id="results" class="results-container" style="display: none;"></div>
    </div>

    <!-- Модальное окно -->
    <div id="optionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let allOptionsData = [];
        let currentModalData = null;

        // Вспомогательная функция для определения типа опциона из данных API
        function getOptionType(data) {
            // Используем поле option_type из API, если оно есть
            if (data.option_type) {
                return data.option_type.toLowerCase();
            }
            
            // Fallback: определяем по SECID (для случаев, когда option_type отсутствует)
            const secid = data.secid || data;
            const lastBIndex = secid.lastIndexOf('B');
            const lastUIndex = secid.lastIndexOf('U');
            return lastBIndex > lastUIndex ? 'call' : 'put';
        }

        async function makeRequest(url) {
            try {
                const response = await fetch(url);
                const data = await response.json();
                return { status: response.status, data: data };
            } catch (error) {
                return { status: 'ERROR', data: { error: error.message } };
            }
        }

        function calculateProfitPotential(data) {
            const underlyingPrice = data.underlying_price;
            const strike = parseFloat(data.secid.match(/\d+\.?\d*/)[0]);
            const optionType = getOptionType(data);
            
            console.log(`Анализ ${data.secid}: тип=${optionType} (из ${data.option_type ? 'API' : 'SECID'})`);
            const daysToExpiry = data.days_until_expiring;
            const volatility = data.volatility;
            const theorPrice = data.theorprice;
            
            let score = 0;
            let reasons = [];
            
            // Анализ денежности для CALL
            if (optionType === 'call') {
                const moneyness = (underlyingPrice - strike) / strike;
                
                if (moneyness > 0.05) {
                    score += 30;
                    reasons.push("✅ Опцион в деньгах - уже есть прибыль");
                } else if (moneyness > -0.02) {
                    score += 20;
                    reasons.push("✅ Опцион около денег - близко к прибыли");
                } else if (moneyness > -0.05) {
                    score += 10;
                    reasons.push("⚠️ Опцион недалеко от денег");
                } else {
                    score -= 10;
                    reasons.push("❌ Опцион далеко от денег - нужен сильный рост");
                }
            }
            
            // Анализ времени до экспирации
            if (daysToExpiry <= 7) {
                score -= 20;
                reasons.push("❌ Очень мало времени - быстрое обесценивание");
            } else if (daysToExpiry <= 14) {
                score -= 10;
                reasons.push("⚠️ Мало времени - высокие временные издержки");
            } else if (daysToExpiry <= 30) {
                score += 10;
                reasons.push("✅ Оптимальное время - баланс стоимости и времени");
            } else if (daysToExpiry <= 90) {
                score += 15;
                reasons.push("✅ Хорошее время - есть время для развития");
            } else {
                score += 5;
                reasons.push("⚠️ Много времени - дорогая временная стоимость");
            }
            
            // Анализ волатильности
            if (volatility > 60) {
                score -= 15;
                reasons.push("❌ Очень высокая волатильность - дорогой опцион");
            } else if (volatility > 40) {
                score -= 5;
                reasons.push("⚠️ Высокая волатильность - повышенная стоимость");
            } else if (volatility > 20) {
                score += 10;
                reasons.push("✅ Умеренная волатильность - разумная цена");
            } else {
                score += 5;
                reasons.push("✅ Низкая волатильность - дешевый опцион");
            }
            
            // Анализ соотношения цена/страйк
            const priceRatio = theorPrice / underlyingPrice;
            if (priceRatio < 0.02) {
                score += 15;
                reasons.push("✅ Очень дешевый опцион - низкий риск");
            } else if (priceRatio < 0.05) {
                score += 10;
                reasons.push("✅ Дешевый опцион - хорошее соотношение");
            } else if (priceRatio < 0.1) {
                score += 5;
                reasons.push("✅ Умеренная цена");
            } else {
                score -= 10;
                reasons.push("❌ Дорогой опцион - высокий риск");
            }
            
            return { score: Math.max(0, Math.min(100, score)), reasons };
        }

        function getTradeRecommendation(score) {
            if (score >= 70) {
                return {
                    action: 'BUY',
                    class: 'recommendation-buy',
                    title: '🟢 СИЛЬНАЯ ПОКУПКА',
                    description: 'Этот опцион имеет отличный потенциал для прибыли с разумным риском.'
                };
            } else if (score >= 50) {
                return {
                    action: 'HOLD',
                    class: 'recommendation-hold',
                    title: '🟡 УМЕРЕННАЯ ПОКУПКА',
                    description: 'Опцион имеет потенциал, но есть риски. Рассмотрите внимательно.'
                };
            } else {
                return {
                    action: 'SELL',
                    class: 'recommendation-sell',
                    title: '🔴 НЕ РЕКОМЕНДУЕТСЯ',
                    description: 'Этот опцион имеет высокий риск и низкий потенциал прибыли.'
                };
            }
        }

        function getDetailedAnalysis(data) {
            const underlyingPrice = data.underlying_price;
            const strike = parseFloat(data.secid.match(/\d+\.?\d*/)[0]);
            const optionType = getOptionType(data);
            const daysToExpiry = data.days_until_expiring;
            const volatility = data.volatility;
            const theorPrice = data.theorprice;
            
            let pros = [];
            let cons = [];
            
            // Анализ денежности
            if (optionType === 'call') {
                const moneyness = (underlyingPrice - strike) / underlyingPrice;
                if (moneyness > 0.05) {
                    pros.push("Опцион в деньгах - уже есть внутренняя стоимость");
                    pros.push("Меньше риска потери всей премии");
                } else if (moneyness < -0.05) {
                    cons.push("Опцион далеко от денег - нужен сильный рост");
                    cons.push("Высокий риск потери всей премии");
                }
            }
            
            // Анализ времени
            if (daysToExpiry <= 7) {
                cons.push("Очень мало времени - быстрое обесценивание");
                cons.push("Высокие временные издержки");
            } else if (daysToExpiry >= 30) {
                pros.push("Достаточно времени для развития позиции");
                pros.push("Умеренные временные издержки");
            }
            
            // Анализ волатильности
            if (volatility > 50) {
                cons.push("Высокая волатильность - дорогая премия");
                cons.push("Сложно предсказать движение");
            } else if (volatility < 30) {
                pros.push("Низкая волатильность - дешевая премия");
                pros.push("Более предсказуемое движение");
            }
            
            // Анализ цены
            const priceRatio = theorPrice / underlyingPrice;
            if (priceRatio < 0.03) {
                pros.push("Очень дешевый опцион - низкий риск");
                pros.push("Высокий потенциал прибыли");
            } else if (priceRatio > 0.08) {
                cons.push("Дорогой опцион - высокий риск");
                cons.push("Нужен сильный рост для прибыли");
            }
            
            // Анализ греков
            if (data.delta > 0.7) {
                pros.push("Высокая чувствительность к движению цены");
            } else if (data.delta < 0.3) {
                cons.push("Низкая чувствительность к движению цены");
            }
            
            if (data.theta > -0.01) {
                pros.push("Медленное временное обесценивание");
            } else {
                cons.push("Быстрое временное обесценивание");
            }
            
            return { pros, cons };
        }

        function calculateBreakEven(data) {
            const strike = parseFloat(data.secid.match(/\d+\.?\d*/)[0]);
            const optionType = getOptionType(data);
            const theorPrice = data.theorprice;
            
            if (optionType === 'call') {
                return strike + theorPrice;
            } else {
                return strike - theorPrice;
            }
        }

        function calculateExpirationDate(daysToExpiry) {
            const today = new Date();
            const expirationDate = new Date(today);
            expirationDate.setDate(today.getDate() + daysToExpiry);
            
            return expirationDate.toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
        }

        function calculateRecommendedPrice(data) {
            const theorPrice = data.theorprice;
            const underlyingPrice = data.underlying_price;
            
            // Рекомендуемая цена покупки: теоретическая цена + небольшой спред
            // Для дешевых опционов спред меньше, для дорогих - больше
            const priceRatio = theorPrice / underlyingPrice;
            let spread = 0;
            
            if (priceRatio < 0.01) {
                spread = 0.01; // 1 копейка для очень дешевых опционов
            } else if (priceRatio < 0.05) {
                spread = theorPrice * 0.05; // 5% спред
            } else {
                spread = theorPrice * 0.03; // 3% спред для дорогих опционов
            }
            
            return theorPrice + spread;
        }

        async function analyzeAllOptions() {
            const assetCode = document.getElementById('assetCode').value.trim();
            const optionType = document.getElementById('optionType').value;
            const tradeType = document.getElementById('tradeType').value;
            
            if (!assetCode) {
                alert('Пожалуйста, введите код базового актива');
                return;
            }
            
            // Показываем загрузку
            document.getElementById('results').innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    Анализируем все опционы на ${assetCode}...
                </div>
            `;
            document.getElementById('results').style.display = 'block';
            document.getElementById('stats').style.display = 'none';
            
            // Получаем список всех опционов
            const optionsUrl = `https://iss.moex.com/iss/apps/option-calc/v1/assets/${assetCode}/options`;
            const optionsResult = await makeRequest(optionsUrl);
            
            if (optionsResult.status !== 200) {
                document.getElementById('results').innerHTML = `
                    <h3>❌ Ошибка получения списка опционов</h3>
                    <p>Статус: ${optionsResult.status}</p>
                    <p>Ошибка: ${optionsResult.data.error || 'Неизвестная ошибка'}</p>
                `;
                return;
            }
            
            // Фильтруем опционы по типу
            const filteredOptions = optionsResult.data.filter(option => {
                // Используем поле option_type из API для точного определения
                const optionTypeFromAPI = option.option_type ? option.option_type.toLowerCase() : null;
                
                if (optionTypeFromAPI) {
                    console.log(`Опцион ${option.secid}: тип из API=${optionTypeFromAPI}, выбранный тип=${optionType}`);
                    return optionTypeFromAPI === optionType;
                } else {
                    // Fallback: определяем по SECID
                    const optionTypeFromSecid = getOptionType(option.secid);
                    console.log(`Опцион ${option.secid}: тип из SECID=${optionTypeFromSecid}, выбранный тип=${optionType}`);
                    return optionTypeFromSecid === optionType;
                }
            });
            
            console.log(`Отфильтровано ${filteredOptions.length} опционов из ${optionsResult.data.length}`);
            console.log('Отфильтрованные опционы:', filteredOptions.map(o => o.secid));
            console.log('Все опционы:', optionsResult.data.map(o => o.secid));
            
            // Анализируем каждый опцион
            allOptionsData = [];
            let processedCount = 0;
            
            for (const option of filteredOptions) {
                const detailUrl = `https://iss.moex.com/iss/apps/option-calc/v1/assets/${assetCode}/options/${option.secid}`;
                const detailResult = await makeRequest(detailUrl);
                
                if (detailResult.status === 200) {
                    const analysis = calculateProfitPotential(detailResult.data);
                    const recommendation = getTradeRecommendation(analysis.score);
                    
                    allOptionsData.push({
                        ...detailResult.data,
                        analysis: analysis,
                        recommendation: recommendation
                    });
                }
                
                processedCount++;
                // Обновляем прогресс
                if (processedCount % 10 === 0) {
                    document.getElementById('results').innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            Обработано ${processedCount} из ${filteredOptions.length} опционов...
                        </div>
                    `;
                }
            }
            
            // Сортируем по рейтингу (лучший первый)
            allOptionsData.sort((a, b) => b.analysis.score - a.analysis.score);
            
            displayResults();
        }

        function displayResults() {
            const assetCode = document.getElementById('assetCode').value.trim();
            const optionType = document.getElementById('optionType').value;
            const tradeType = document.getElementById('tradeType').value;
            
            // Статистика
            const totalOptions = allOptionsData.length;
            const excellentOptions = allOptionsData.filter(o => o.analysis.score >= 70).length;
            const goodOptions = allOptionsData.filter(o => o.analysis.score >= 50 && o.analysis.score < 70).length;
            const poorOptions = allOptionsData.filter(o => o.analysis.score < 50).length;
            
            let statsHtml = `
                <h3>📊 Статистика анализа</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${totalOptions}</div>
                        <div class="stat-label">Всего опционов</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #27ae60;">${excellentOptions}</div>
                        <div class="stat-label">Отличных (70+)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #f39c12;">${goodOptions}</div>
                        <div class="stat-label">Хороших (50-69)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" style="color: #e74c3c;">${poorOptions}</div>
                        <div class="stat-label">Плохих (<50)</div>
                    </div>
                </div>
                <div class="info-box">
                    <strong>⚠️ Важно:</strong> Рейтинг основан на теоретических параметрах. Перед покупкой проверьте ликвидность опциона в торговом терминале!
                </div>
            `;
            
            document.getElementById('stats').innerHTML = statsHtml;
            document.getElementById('stats').style.display = 'block';
            
            // Список опционов
            let resultsHtml = `
                <h3>🏆 Рейтинг опционов ${assetCode} ${optionType.toUpperCase()} (${tradeType.toUpperCase()})</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px;">
                    <strong>Фильтр:</strong> ${optionType === 'call' ? 'CALL опционы (по полю option_type из API)' : 'PUT опционы (по полю option_type из API)'}
                </p>
                <div class="options-list">
            `;
            
            allOptionsData.forEach((option, index) => {
                const scoreClass = option.analysis.score >= 70 ? 'excellent' : 
                                 option.analysis.score >= 50 ? 'good' : 'poor';
                const scoreColorClass = option.analysis.score >= 70 ? 'score-excellent' : 
                                       option.analysis.score >= 50 ? 'score-good' : 'score-poor';
                const recommendationClass = option.recommendation.action === 'BUY' ? 'recommendation-buy' :
                                           option.recommendation.action === 'HOLD' ? 'recommendation-hold' : 'recommendation-sell';
                
                const breakEvenPrice = calculateBreakEven(option);
                const underlyingPrice = option.underlying_price;
                const strike = parseFloat(option.secid.match(/\d+\.?\d*/)[0]);
                
                resultsHtml += `
                    <div class="option-card ${scoreClass}" onclick="openModal(${index})">
                        <div class="option-header">
                            <div class="option-title">#${index + 1} ${option.secid}</div>
                            <div class="option-score ${scoreColorClass}">${option.analysis.score}/100</div>
                        </div>
                        
                        <div class="option-details">
                            <div class="detail-item">
                                <div class="detail-value">${strike}</div>
                                <div class="detail-label">Страйк</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${option.theorprice.toFixed(2)}</div>
                                <div class="detail-label">Цена</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${option.days_until_expiring}</div>
                                <div class="detail-label">Дней</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${breakEvenPrice.toFixed(2)}</div>
                                <div class="detail-label">Безубыток</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-value">${calculateExpirationDate(option.days_until_expiring).split(' ')[1]}</div>
                                <div class="detail-label">Месяц</div>
                            </div>
                        </div>
                        
                        <div class="option-recommendation ${recommendationClass}">
                            ${option.recommendation.title}
                        </div>
                    </div>
                `;
            });
            
            resultsHtml += '</div>';
            document.getElementById('results').innerHTML = resultsHtml;
        }

        function openModal(index) {
            const option = allOptionsData[index];
            currentModalData = option;
            
            const detailedAnalysis = getDetailedAnalysis(option);
            const breakEvenPrice = calculateBreakEven(option);
            const recommendedPrice = calculateRecommendedPrice(option);
            const expirationDate = calculateExpirationDate(option.days_until_expiring);
            const underlyingPrice = option.underlying_price;
            const strike = parseFloat(option.secid.match(/\d+\.?\d*/)[0]);
            const optionType = getOptionType(option);
            
            console.log(`Модалка для ${option.secid}: тип=${optionType} (из ${option.option_type ? 'API' : 'SECID'})`);
            
            let modalHtml = `
                <div class="modal-header">
                    <div class="modal-title">🎯 Детальный анализ: ${option.secid}</div>
                    <div class="modal-subtitle">Позиция в рейтинге: #${index + 1} из ${allOptionsData.length}</div>
                </div>
                
                <div class="${option.recommendation.class}">
                    <h3>${option.recommendation.title}</h3>
                    <p><strong>${option.recommendation.description}</strong></p>
                </div>
                
                <div class="score-card">
                    <h3>📊 Оценка потенциала: ${option.analysis.score}/100</h3>
                    <div class="score-bar">
                        <div class="score-fill ${option.analysis.score >= 70 ? 'score-excellent' : option.analysis.score >= 50 ? 'score-good' : 'score-poor'}" 
                             style="width: ${option.analysis.score}%"></div>
                    </div>
                    <p><strong>Обоснование:</strong></p>
                    <ul>
                        ${option.analysis.reasons.map(reason => `<li>${reason}</li>`).join('')}
                    </ul>
                </div>
                
                <div class="price-analysis">
                    <h3>💰 Анализ цен</h3>
                    <div class="price-breakdown">
                        <div class="price-item">
                            <div class="price-value">${underlyingPrice}</div>
                            <div class="price-label">Цена базового актива</div>
                        </div>
                        <div class="price-item">
                            <div class="price-value">${strike}</div>
                            <div class="price-label">Страйк опциона</div>
                        </div>
                        <div class="price-item">
                            <div class="price-value">${option.theorprice.toFixed(2)}</div>
                            <div class="price-label">Теоретическая цена</div>
                        </div>
                        <div class="price-item">
                            <div class="price-value">${recommendedPrice.toFixed(2)}</div>
                            <div class="price-label">Рекомендуемая цена покупки</div>
                        </div>
                        <div class="price-item">
                            <div class="price-value">${breakEvenPrice.toFixed(2)}</div>
                            <div class="price-label">Точка безубыточности</div>
                        </div>
                    </div>
                    <p><strong>Для прибыли ${optionType === 'call' ? 'цена БА должна вырасти' : 'цена БА должна упасть'} до ${breakEvenPrice.toFixed(2)}</strong></p>
                </div>
                
                <div class="pros-cons">
                    <div class="pros">
                        <h4>✅ Преимущества</h4>
                        <ul>
                            ${detailedAnalysis.pros.map(pro => `<li>${pro}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="cons">
                        <h4>❌ Риски</h4>
                        <ul>
                            ${detailedAnalysis.cons.map(con => `<li>${con}</li>`).join('')}
                        </ul>
                    </div>
                </div>
                
                <div class="analysis-section">
                    <h3>📈 Детальный анализ</h3>
                    <p><strong>Тип опциона:</strong> ${optionType.toUpperCase()}</p>
                    <p><strong>Дата погашения:</strong> ${expirationDate}</p>
                    <p><strong>Дней до экспирации:</strong> ${option.days_until_expiring}</p>
                    <p><strong>Волатильность:</strong> ${option.volatility}%</p>
                    <p><strong>Комиссия:</strong> ${option.fee}</p>
                    
                    <h4>Риск-параметры:</h4>
                    <p><strong>Delta:</strong> ${option.delta.toFixed(4)} - чувствительность к цене БА</p>
                    <p><strong>Gamma:</strong> ${option.gamma.toFixed(6)} - скорость изменения Delta</p>
                    <p><strong>Theta:</strong> ${option.theta.toFixed(6)} - временное обесценивание</p>
                    <p><strong>Vega:</strong> ${option.vega.toFixed(2)} - чувствительность к волатильности</p>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = modalHtml;
            document.getElementById('optionModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('optionModal').style.display = 'none';
        }

        // Закрытие модалки при клике вне её
        window.onclick = function(event) {
            const modal = document.getElementById('optionModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html> 